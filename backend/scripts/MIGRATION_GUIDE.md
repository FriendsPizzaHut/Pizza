# Menu Items Migration Guide

## Overview
This script migrates your old menu items to the new database format with enhanced descriptions and proper pricing structure.

## What It Does

1. **Transforms old data format** to match the new Product schema
2. **Generates multi-size pricing** for pizzas (Small/Medium/Large)
3. **Adds detailed descriptions** for each menu item
4. **Preserves important data** like images, vegetarian status, availability
5. **Auto-generates fields** like preparation time, discount, rating

## Before Running

### Prerequisites
- MongoDB connection string in `.env` file
- No existing products in database (or you accept to overwrite)

### Backup Your Data
```bash
# If you have existing data, create a backup first
mongodump --uri="your-mongodb-uri" --out=./backup
```

## How to Run

### Method 1: Direct Execution
```bash
cd backend
node scripts/migrateMenuItems.js
```

### Method 2: Using npm script (add to package.json)
```json
{
  "scripts": {
    "migrate:menu": "node scripts/migrateMenuItems.js"
  }
}
```

Then run:
```bash
npm run migrate:menu
```

## What Gets Migrated

### 20 Menu Items:
- **15 Pizzas** (Vegetarian)
  - The Friends Overloaded
  - Panner Makhni  
  - The Friends overload veg
  - Mexican Style
  - Magic Mushroom
  - Peri Peri
  - Fire in the hole
  - Margherita
  - Veggie Fresh
  - Veg Hawaiian
  - Onion Pizza
  - Sweet Corn
  - Dragon Kiss
  - Farm house
  - Garden Delight

- **5 Sides** (Non-Vegetarian Chicken Items)
  - American Chicken
  - American fried chicken wings
  - BBQ Chicken Strips
  - Chicken Strips
  - Chicken Popcorn

## Data Transformation

### Old Format
```json
{
  "name": "Margherita",
  "description": "Only cheese pizza",
  "category": "Pizza",
  "price": 0,
  "sizeVariations": [],
  "isVeg": true
}
```

### New Format
```json
{
  "name": "Margherita",
  "description": "A timeless Italian classic that celebrates simplicity...",
  "category": "pizza",
  "pricing": {
    "small": 99,
    "medium": 149,
    "large": 199
  },
  "imageUrl": "https://...",
  "isVegetarian": true,
  "isAvailable": true,
  "preparationTime": 20,
  "discountPercent": 15,
  "rating": 4.0
}
```

## Generated Prices

### Pizzas (Multi-size)
- **Small**: ₹99 (default if not specified)
- **Medium**: ₹149 (default if not specified)  
- **Large**: ₹199 (default if not specified)

### Sides (Single price)
- **Default**: ₹150 (if not specified in old data)
- **Actual prices preserved** from old data where available

## Auto-Generated Fields

The following fields are automatically generated by the Product model:

1. **preparationTime**: Based on category (pizza: 20 min, sides: 10 min)
2. **discountPercent**: Random 10-25% discount
3. **basePrice**: Calculated from pricing (smallest size for pizzas)
4. **rating**: Defaults to 4.0
5. **salesCount**: Starts at 0
6. **totalRevenue**: Starts at 0

## Safety Features

- **Checks for existing data** before migrating
- **Validates data** against Product schema
- **Transaction support** (all or nothing)
- **Detailed logging** of the migration process
- **Error handling** with rollback on failure

## After Migration

### Verify the Data
```bash
# Using MongoDB shell or Compass
# Check total count
db.products.countDocuments()

# Check a sample item
db.products.findOne({ name: "Margherita" })

# List all pizzas
db.products.find({ category: "pizza" })
```

### Update Prices (if needed)
After migration, you can update prices through:
1. Admin panel (MenuManagementScreen)
2. Direct API calls
3. MongoDB compass/shell

## Customization

### Change Default Prices
Edit the `transformMenuItem` function:

```javascript
if (category === 'pizza') {
    pricing = {
        small: 129,   // Your custom price
        medium: 179,  // Your custom price
        large: 229    // Your custom price
    };
}
```

### Add More Items
Add items to the `oldMenuItems` array:

```javascript
const oldMenuItems = [
    // ... existing items ...
    {
        name: "New Pizza",
        description: "Description",
        category: "Pizza",
        available: true,
        isVeg: true,
        image: "https://..."
    }
];
```

### Modify Descriptions
Edit the `enhancedDescriptions` object to change item descriptions.

## Troubleshooting

### Error: "MONGODB_URI not found"
**Solution**: Make sure your `.env` file has the MongoDB connection string:
```env
MONGODB_URI=mongodb://localhost:27017/pizza-app
# or
MONGODB_URI=mongodb+srv://user:pass@cluster.mongodb.net/pizza-app
```

### Error: "Validation failed"
**Solution**: Check that all required fields are present:
- name
- description
- category (must be lowercase)
- pricing (correct format for category)
- imageUrl

### Error: "Duplicate key error"
**Solution**: Products with same name already exist. Either:
1. Delete existing products
2. Modify the item names in the script
3. Skip migration if data is already present

### Migration seems stuck
**Solution**: 
1. Check MongoDB connection
2. Check network connectivity
3. Look at MongoDB logs for issues

## Rolling Back

If something goes wrong:

```bash
# Restore from backup
mongorestore --uri="your-mongodb-uri" ./backup

# Or delete migrated items
db.products.deleteMany({})
```

## Next Steps

After successful migration:

1. ✅ Verify all items in admin panel
2. ✅ Update prices if needed
3. ✅ Add proper product images (re-upload to Cloudinary/FriendsPizzaHut folder)
4. ✅ Test ordering flow
5. ✅ Set popular items manually if needed

## Need Help?

- Check MongoDB logs: `tail -f /var/log/mongodb/mongod.log`
- Check script output for errors
- Use MongoDB Compass to inspect the database
- Review Product model schema for validation rules

---

**Last Updated**: October 26, 2025
**Version**: 1.0.0
